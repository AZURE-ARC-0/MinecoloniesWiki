---
import '../css/globals.scss';
import '@fontsource/fondamento';

import Footer from '@components/Footer.astro';
import Header from '@components/Header.astro';
import Meta from '@components/Meta.astro';
import Navigation from '@components/navbar/Navigation.astro';
import PageRoot from '@components/PageRoot.astro';
import Container from '@components/ui/Container.astro';
import PageTitleRender from '@components/wiki/PageTitleRender.astro';
import { getNewestVersion } from '@utils/version';
import type { Title } from '@utils/wiki';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: Title;
  titleAffix?: string;
  header?: string;
  showHeader?: boolean;
}

const { title, titleAffix = 'MineColonies', header = title, showHeader = true } = Astro.props;

const isHome = Astro.url.pathname === '/';
const isWikiPage = Astro.url.pathname.startsWith('/wiki');

const newestVersion = await getNewestVersion();

let versionTitleData: Record<string, string>;
if (typeof title === 'object') {
  versionTitleData = title.reduce<Record<string, string>>((previousValue, currentValue) => {
    for (const version of currentValue.versions) {
      previousValue['data-title-version-' + version.data.order] = currentValue.title;
    }
    return previousValue;
  }, {});
} else {
  versionTitleData = { 'data-title-version-all': title };
}

const initialTitle =
  typeof title === 'string'
    ? title
    : title.find((f) => f.versions.map((v) => v.id).includes(newestVersion.id))?.title + ' | ' + titleAffix;
---

<!doctype html>
<html lang="en" transition:persist>
  <head>
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-element-bundle.min.js"></script>

    <title property="og-title,twitter:title">
      {initialTitle}
    </title>

    <slot name="meta">
      <Meta isWiki={isWikiPage} title={initialTitle} />
    </slot>

    <script is:inline>
      function updateTitle(version) {
        let newTitle;
        if (document.body.dataset.titleVersionAll) {
          newTitle = document.body.dataset.titleVersionAll;
        } else {
          newTitle = document.body.dataset[`titleVersion-${version}`];
        }
        document.title = `${newTitle} | ${document.body.dataset.titleAffix ?? 'Minecolonies'}`;
      }

      function update(mutations) {
        for (const mutation of mutations) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'data-version') {
            updateTitle(mutation.target.dataset.version);
          }
        }
      }

      const versionObserver = new MutationObserver(update);

      function setup() {
        versionObserver.observe(document.body, { attributes: true });
        updateTitle(document.body.dataset.version);
      }

      document.addEventListener('astro:page-load', setup);
    </script>

    <ViewTransitions />
  </head>
  <body data-latest-version={newestVersion.data.order} {...versionTitleData} data-title-affix={titleAffix}>
    <PageRoot isHome={isHome}>
      <div class="page_root p-5">
        <Header isWiki={isWikiPage} />
        <Navigation isWiki={isWikiPage} />

        <div transition:animate="fade" class="page_content">
          {
            showHeader && (
              <>
                <h1 class="page_header text-center m-0">
                  <PageTitleRender title={header} />
                </h1>
              </>
            )
          }

          <Container>
            <slot slot="left" name="left" />
            <hr />
            <slot />
            <slot slot="right" name="right" />
          </Container>
        </div>
        <Footer />
      </div>
    </PageRoot>
  </body>
</html>
